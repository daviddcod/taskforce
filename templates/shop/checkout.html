{% extends 'base.html' %}

{% block content %}
<h1>Checkout</h1>

{% if cart_items %}
    <h2>Review your order</h2>
    <table>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Subtotal</th>
        </tr>
        {% for item in cart_items %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>${{ item.product.price }}</td>
                <td>${{ item.subtotal }}</td>
            </tr>
        {% endfor %}
        <tr>
            <td colspan="3"><strong>Total</strong></td>
            <td><strong>${{ total_price }}</strong></td>
        </tr>
    </table>

    <!-- Stripe Checkout Button -->
    <form action="{% url 'create_checkout_session' %}" method="POST">
        {% csrf_token %}
        <button type="submit" id="checkout-button">Proceed to Payment</button>
    </form>

{% else %}
    <p>Your cart is empty.</p>
{% endif %}

<script src="https://js.stripe.com/v3/"></script>
<script>
    // Create an instance of the Stripe object with your publishable API key
    var stripe = Stripe("{{ stripe_public_key }}");
    var checkoutButton = document.getElementById("checkout-button");

    checkoutButton.addEventListener("click", function () {
        fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
        })
        .then(function (response) {
            return response.json();
        })
        .then(function (session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .then(function (result) {
            if (result.error) {
                alert(result.error.message);
            }
        })
        .catch(function (error) {
            console.error("Error:", error);
        });
    });
</script>

{% endblock %}
